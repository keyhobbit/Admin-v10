---
- name: Deploy AFK Game Application
  hosts: "{{ target | default('staging') }}"
  become: yes
  vars:
    app_name: afk-game
    app_directory: /var/www/{{ app_name }}
    repository_url: "https://github.com/keyhobbit/Admin-v10.git"
    branch: "{{ git_branch | default('main') }}"
    docker_compose_file: "{{ 'docker-compose-vps.yml' if target == 'production' else 'docker-compose-local.yml' }}"
    
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install required packages
      apt:
        name:
          - git
          - curl
          - docker.io
          - docker-compose
        state: present

    - name: Ensure Docker is running
      service:
        name: docker
        state: started
        enabled: yes

    - name: Create application directory
      file:
        path: "{{ app_directory }}"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0755'

    - name: Clone/Update repository
      git:
        repo: "{{ repository_url }}"
        dest: "{{ app_directory }}"
        version: "{{ branch }}"
        force: yes
      register: git_result

    - name: Copy environment file
      template:
        src: ../templates/.env.j2
        dest: "{{ app_directory }}/source_code/.env"
        mode: '0644'

    - name: Stop existing containers
      command: docker compose -f docker/{{ docker_compose_file }} down
      args:
        chdir: "{{ app_directory }}"
      ignore_errors: yes

    - name: Build and start containers
      command: docker compose -f docker/{{ docker_compose_file }} up -d --build
      args:
        chdir: "{{ app_directory }}"

    - name: Wait for MySQL to be ready
      wait_for:
        host: localhost
        port: 3308
        delay: 10
        timeout: 60

    - name: Set proper permissions for storage and cache directories
      command: docker compose -f docker/{{ docker_compose_file }} exec -T -u root app chown -R 1000:1000 /var/www/storage /var/www/bootstrap/cache
      args:
        chdir: "{{ app_directory }}"
      ignore_errors: yes

    - name: Install composer dependencies
      command: docker compose -f docker/{{ docker_compose_file }} exec -T -u root app composer install --no-dev --optimize-autoloader
      args:
        chdir: "{{ app_directory }}"

    - name: Create cache and session tables
      command: docker compose -f docker/{{ docker_compose_file }} exec -T -u root app php artisan {{ item }}
      args:
        chdir: "{{ app_directory }}"
      loop:
        - cache:table
        - session:table
      ignore_errors: yes

    - name: Run database migrations
      command: docker compose -f docker/{{ docker_compose_file }} exec -T -u root app php artisan migrate --force
      args:
        chdir: "{{ app_directory }}"

    - name: Clear and cache config
      command: docker compose -f docker/{{ docker_compose_file }} exec -T -u root app php artisan {{ item }}
      args:
        chdir: "{{ app_directory }}"
      loop:
        - config:cache
        - route:cache
        - view:cache

    - name: Create storage link
      command: docker compose -f docker/{{ docker_compose_file }} exec -T -u root app php artisan storage:link
      args:
        chdir: "{{ app_directory }}"
      ignore_errors: yes

  handlers:
    - name: restart containers
      command: docker compose -f docker/{{ docker_compose_file }} restart
      args:
        chdir: "{{ app_directory }}"
